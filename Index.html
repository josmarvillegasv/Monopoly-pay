<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monopoly Digital - Josmar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.29.9.min.js"></script>
    <style>
        :root { --p: #2c3e50; --s: #27ae60; --d: #e74c3c; --l: #ecf0f1; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--l); margin: 0; padding: 15px; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .saldo { font-size: 2.8rem; font-weight: bold; color: var(--s); margin: 5px 0; }
        button { width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: bold; color: white; cursor: pointer; font-size: 1.1rem; background: var(--s); }
        .history-container { background: white; border-radius: 15px; padding: 15px; text-align: left; max-height: 200px; overflow-y: auto; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .history-item { font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid #eee; }
        .in { color: var(--s); font-weight: bold; }
        .out { color: var(--d); font-weight: bold; }
        h3 { font-size: 1rem; color: var(--p); margin-top: 20px; }
    </style>
</head>
<body>

    <header><h2>ðŸ’¸ Monopoly Online</h2></header>

    <div class="card">
        <div id="player-info" style="font-weight: bold; color: var(--p);">...</div>
        <div class="saldo" id="display-saldo">$0</div>
        <div id="net-status" style="font-size: 0.7rem; color: gray;">Conectando...</div>
    </div>

    <button onclick="enviarDinero()">ðŸ“¤ ENVIAR DINERO</button>

    <h3>Historial de Movimientos</h3>
    <div class="history-container" id="historial">
        <div class="history-item" style="color:gray; text-align:center;">No hay transacciones aÃºn.</div>
    </div>

    <script>
        let miNombre = localStorage.getItem('mono_name') || prompt("Tu nombre:");
        if(!miNombre) miNombre = "Jugador_" + Math.floor(Math.random()*1000);
        localStorage.setItem('mono_name', miNombre);
        document.getElementById('player-info').innerText = "JUGADOR: " + miNombre.toUpperCase();

        let saldo = parseInt(localStorage.getItem('mono_saldo')) || 1500;
        let historial = JSON.parse(localStorage.getItem('mono_historial')) || [];

        const pubnub = new PubNub({
            publishKey: 'pub-c-490333d4-b789-4076-902e-c75240292701',
            subscribeKey: 'sub-c-0740a6b4-022e-11eb-a2b8-0a64736f8303',
            uuid: miNombre
        });

        pubnub.subscribe({ channels: ['monopoly_directo'] });
        pubnub.addListener({
            message: (m) => {
                if (m.message.to === miNombre) {
                    saldo += m.message.amount;
                    agregarHistorial(`Recibiste de ${m.message.from}`, m.message.amount, 'in');
                    actualizar();
                }
            }
        });

        function actualizar() {
            const formato = new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2 }).format(saldo);
            document.getElementById('display-saldo').innerText = '$' + formato;
            localStorage.setItem('mono_saldo', saldo);
            localStorage.setItem('mono_historial', JSON.stringify(historial));
            dibujarHistorial();
            document.getElementById('net-status').innerText = "Servidor Activo";
        }

        function agregarHistorial(msg, monto, tipo) {
            historial.unshift({ msg, monto, tipo, fecha: new Date().toLocaleTimeString() });
            if(historial.length > 10) historial.pop();
        }

        function dibujarHistorial() {
            const cont = document.getElementById('historial');
            if(historial.length === 0) return;
            cont.innerHTML = historial.map(h => `
                <div class="history-item">
                    <small>${h.fecha}</small> | ${h.msg} <span class="${h.tipo}">${h.tipo === 'in' ? '+' : '-'}$${h.monto}</span>
                </div>
            `).join('');
        }

        async function enviarDinero() {
            const receptor = prompt("Â¿A quiÃ©n envÃ­as?");
            if (!receptor) return;
            const monto = parseInt(prompt("Monto:"));
            if (isNaN(monto) || monto <= 0 || monto > saldo) return alert("Monto invÃ¡lido o insuficiente");

            try {
                await pubnub.publish({
                    channel: 'monopoly_directo',
                    message: { from: miNombre, to: receptor, amount: monto }
                });
                saldo -= monto;
                agregarHistorial(`Enviaste a ${receptor}`, monto, 'out');
                actualizar();
            } catch (e) { alert("Error de red"); }
        }

        actualizar();
    </script>
</body>
</html>
